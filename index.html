<!DOCTYPE html>
<html>
<head>
    <title>Option Finder</title>
    <script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/i18n/he.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body {
            direction: rtl;
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333333;
            font-size: 2em;
            text-align: center;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 1.2em;
            color: #666666;
        }

        select {
            width: 100%;
            max-width: 360px;
            height: 30px;
            font-size: 1em;
            color: #333333;
            padding: 5px;
            margin-top: 5px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            max-width: 360px;
        }

        button:hover {
            background-color: #45a049;
        }

        p {
            font-size: 1em;
            margin-top: 10px;
            text-align: center;
        }

        b{
            font-size: 1.3em;
    color: #1c761f;
        }

            #creator{
                direction: ltr;
                position: absolute;
                left: 10px;
                bottom: 5px;
                font-size: 1em;
                color: rgb(92, 92, 92);
            }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            label {
                font-size: 1em;
            }

            select, button {
                font-size: 0.8em;
            }

            p {
                font-size: 0.8em;
            }
        }
    </style>
    
    <script>
    const banned_cafeterias = ["פביולה","שפרינצק"]
           // Google Sheets document URL
    const DOCUMENT_URL = '1TvwY0_BjVmWfKfTCZ_nUjWLvLRgv7npurCEamJIsHHY';

let data;

// Fetch data from the Google Sheets document
const fetchData = async () => {
    const response = await fetch(`https://docs.google.com/spreadsheets/d/${DOCUMENT_URL}/gviz/tq?tqx=out:json&gid=0`);
    const txt = await response.text();
    const jsonString = txt.match(/"table":.*(?=}\);)/g)[0].replace('"table":', '');
    console.log(JSON.parse(jsonString))
    return JSON.parse(jsonString);
}

// Handle error during fetching data
const getData = async () => {
    try {
        return await fetchData();
    } catch (error) {
        console.error('Error:', error);
        return null;
    }
}

// Extract distinct item names from the data
const getItemNames = (data) => {
    const itemsColumnIndex = data.cols.length - 1;
    return data.rows.map(row => row.c[itemsColumnIndex].v)
        .filter((item, index, self) => self.indexOf(item) === index);
}

// Populate the items select input
const populateItemsSelect = async () => {
    data = await getData();

    if (data) {
        const itemNames = getItemNames(data);
        const itemsSelect = document.getElementById('item');
        itemsSelect.innerHTML = '';

        itemNames.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.text = item;
            itemsSelect.appendChild(option);
        });
    }
}

// Extract options from the data
const getOptions = (data, item) => {
    const itemsColumnIndex = data.cols.length - 1;
    const itemRowIndex = data.rows.findIndex(row => row.c[itemsColumnIndex].v === item);

    if (itemRowIndex === -1) return [];
    console.log(data.rows[itemRowIndex])
    let options = [];
    for (let i = itemsColumnIndex - 1; i >= 0; i--) {
        const cafeteria = data.cols[i].label;
        const rowData = data.rows[itemRowIndex]?.c[i];

        if (!rowData) {
            continue;
        }

        const value = String(rowData?.f ?? rowData?.v).replace(/[\u0590-\u05FFa-zA-Z"]/g, '').replace(/\s+/g, ' ').trim();
        
        const numbers = value.split(/[\/\s-]+/).map(Number);
        const price = Math.min(...numbers);

        options.push({ cafeteria, price });
    }

    return options.sort((a, b) => a.price - b.price);
}

const generateHTML = (item, options) => {
    if (options.length === 0) {
        return `המוצר הבא לא נמצא: ${item}`;
    }

    return options.map((option, index) => {
        let cafeteriaName = option.cafeteria;
        let notice = '';
        if (banned_cafeterias.includes(option.cafeteria)) {
            cafeteriaName = `<span style='color: white; background: #a50b0b;'>${option.cafeteria}</span>`;
            notice = `<span style=' color: #a50b0b;'>מוחרמת</span>`;
        }

        return index === 0
            ? `<b style='color:black;font-size:1.1em'>האופציה הזולה ביותר עבור ${item}:</b> <b> ${cafeteriaName} (₪${option.price})</b> ${notice}<br> <br>`
            : `${cafeteriaName} - ₪${option.price} ${notice}<br>`;
    }).join('');
};

// Function to find the cheapest option for a given item
const findOptions = () => {
    const item = document.getElementById('item').value;

    if (data) {
        const options = getOptions(data, item);
        const resultHTML = generateHTML(item, options);
        document.getElementById('result').innerHTML = resultHTML;
    }
}
$(document).ready(function() {
    $('#item').select2({
  dir: "rtl",
  language: "he"
});
});
    </script>
</head>
<body onload="populateItemsSelect()">
    <h1>מציאת האופציה הזולה ביותר בקמפוס</h1>
    <p>יתכן ומספר מוצרים לא יעבדו בגלל הדרך בה המחיר שלהם רשום במסמך, יסודר בהמשך</p>
    <label for="item">בחר מוצר:</label>
    <select id="item" name="item">
        <!-- Options will be populated dynamically -->
    </select>
    <button onclick="findOptions()">מצא מוצרים</button>
    <p id="result"></p>
    <a href="https://docs.google.com/spreadsheets/d/1TvwY0_BjVmWfKfTCZ_nUjWLvLRgv7npurCEamJIsHHY/edit#gid=0">המסמך ממנו האתר שואב את הנתונים</a>
    <div id='creator'>Made by Itai L.</div>
</body>
</html>
